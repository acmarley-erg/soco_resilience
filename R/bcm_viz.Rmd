---
title: "Sonoma County BCM data"
output: html_document
date: '2022-03-10'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
library(tidyverse)
library(sf)
library(here)
library(ggthemes)
library(raster)
library(RColorBrewer)
```

```{r, include=FALSE}
### read in shapefiles ###

## Administrative boundaries
soco_bound <- read_sf(here("data/clean/sonoma_county_boundary/sonoma_county_boundary.shp"))
ca_state <- sf::read_sf(here("data/clean/ca_state_boundary/ca_state_boundary.shp"))

# BCM projected data
bcm_proj_data <- read_sf(here("data/clean/soco_bcm/soco_bcm_full_ws.shp"))
bcm_hist <- read_csv(here("data/clean/soco_bcm/bcm_hist_base.csv"))
```

```{r, include=FALSE}
# source functions
source(here("R/utils/bcm_plot.R"))
```

```{r, include=FALSE}
# tidy historical data
bcm_hist_tidy <- bcm_hist %>% 
  dplyr::select(-"...1", -gcm, -wyear_group) %>% 
  pivot_longer(c("stor", "rch", "run", "aet", "cwd", "tmax", "tmin", "ppt", "pet"), names_to = "climate_variables", values_to = "hist_values") %>% 
  mutate(watershed_num = as.character(watershed_num))
```

```{r, include=FALSE}
# make historical data into a shapefile
soco_ws <- bcm_proj_data %>% 
  dplyr::select(watershed_) %>% 
  rename(watershed_num = watershed_) %>% 
  mutate(watershed_num = as.numeric(watershed_num))

hist_shp <- dplyr::left_join(soco_ws, bcm_hist, by = "watershed_num" ) %>% 
  st_as_sf() %>% 
  dplyr::select(-"...1") %>% 
  relocate(geometry, .after = gcm) %>% 
   rename(wyear_grou = wyear_group) 

bcm_proj <- bcm_proj_data %>% 
  # filter to just the gcms we're looking at
  filter(gcm %in% c("MIROC_rcp85", "CNRM_rcp85")) %>% 
  dplyr::select(-Area_acre) %>% 
  rename(watershed_num = watershed_) %>% 
  mutate(watershed_num = as.numeric(watershed_num))

bcm_proj_hist_wide <- rbind(bcm_proj, hist_shp)
```


```{r, include=FALSE}
# put historical change and future projected conditions into a tidy format
bcm_tidy <- bcm_proj_data %>% 
  # filter to just the gcms we're looking at
  filter(gcm %in% c("MIROC_rcp85", "CNRM_rcp85")) %>% 
  rename(watershed_num = watershed_) %>% 
  # convert to tidy format
  pivot_longer(c("stor", "rch", "run", "aet", "cwd", "tmax", "tmin", "ppt", "pet"), names_to = "climate_variables", values_to = "values") %>% 
  left_join(bcm_hist_tidy, by=c("watershed_num", "climate_variables")) %>% 
  mutate(change_from_hist = values - hist_values) %>% 
  st_as_sf()
```

```{r, include=FALSE}
# filter to just the hot and dry scenario
bcm_cnrm <- bcm_proj_hist_wide %>% 
  filter(gcm %in% c("CNRM_rcp85", "HST"))

# filter to just the hot and dry scenario
bcm_miroc <- bcm_proj_hist_wide %>% 
  filter(gcm %in% c("MIROC_rcp85", "HST"))
```

#### **Max temperature**

```{r, echo = FALSE}
bcm_plot(bcm_miroc, bcm_miroc$tmax, "Max Temperature (째C)", "MIROC RCP 8.5 (hot, low rainfall)", "YlOrBr", col_limits = c(16,29))
bcm_plot(bcm_cnrm, bcm_cnrm$tmax, "Max Temperature (째C)", "CNRM RCP 8.5 (warm, high rainfall)", "YlOrBr", col_limits = c(16,29))
```


#### **Min temperature**

```{r, echo = FALSE}
bcm_plot(bcm_miroc, bcm_miroc$tmin, "Min Temperature (째C)", "MIROC RCP 8.5 (hot, low rainfall)", "Blues", pal_dir = -1, col_limits = c(6,14))
bcm_plot(bcm_cnrm, bcm_cnrm$tmin, "Min Temperature (째C)", "CNRM RCP 8.5 (warm, high rainfall)", "Blues", pal_dir = -1, col_limits = c(6,14))
```

#### **Precipitation**

```{r, echo = FALSE}
bcm_plot(bcm_miroc, bcm_miroc$ppt, "Precipitation", "MIROC RCP 8.5 (hot, low rainfall)", "YlGnBu", col_limits = c(34,198))
bcm_plot(bcm_cnrm, bcm_cnrm$ppt, "Precipitation", "CNRM RCP 8.5 (warm, high rainfall)", "YlGnBu", col_limits = c(34,198))
```


#### **Climatic Water Deficit**

```{r, echo = FALSE}
bcm_plot(bcm_miroc, bcm_miroc$cwd, "Climatic Water Deficit", "MIROC RCP 8.5 (hot, low rainfall)", "YlOrRd", col_limits = c(43,83))
bcm_plot(bcm_cnrm, bcm_cnrm$cwd, "Climatic Water Deficit", "CNRM RCP 8.5 (warm, high rainfall)", "YlOrRd", col_limits = c(43,83))
```


